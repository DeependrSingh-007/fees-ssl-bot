<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Savitri Success Library | Modern Dashboard</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      /* ðŸŒŸ Sparkle Theme: Light, Vibrant, Glassy */
      --primary: #8b5cf6;
      /* Vibrant Purple */
      --primary-grad: linear-gradient(135deg, #8b5cf6 0%, #aa77ff 100%);
      --accent: #f472b6;
      /* Pink Accent */
      --accent-grad: linear-gradient(135deg, #f472b6 0%, #fb923c 100%);

      --bg-body: #fdf2f8;
      /* Very pale pink/white */
      --bg-glass: rgba(255, 255, 255, 0.7);
      /* Glass Card */
      --bg-sidebar: rgba(255, 255, 255, 0.85);

      --text-main: #334155;
      --text-muted: #64748b;
      --text-light: #94a3b8;

      --border: rgba(255, 255, 255, 0.6);

      /* Status Colors */
      --success: #10b981;
      --success-bg: #d1fae5;
      --danger: #ef4444;
      --danger-bg: #fee2e2;
      --warn: #f59e0b;
      --warn-bg: #fef3c7;

      /* Effects */
      --shadow-sm: 0 4px 6px -1px rgba(139, 92, 246, 0.05);
      --shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.1), 0 8px 10px -6px rgba(139, 92, 246, 0.05);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
      --glow: 0 0 15px rgba(139, 92, 246, 0.3);

      --radius: 20px;
      --radius-sm: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      /* ðŸŒˆ Animated Gradient Background */
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;

      color: var(--text-main);
      margin: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    @keyframes gradientBG {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* ðŸŒŸ Sparkle Overlay */
    body::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    /* Layout */
    .sidebar {
      width: 270px;
      background: var(--bg-sidebar);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-right: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: width 0.3s;
      z-index: 10;
      box-shadow: var(--glass-shadow);
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      z-index: 1;
      background: rgba(255, 255, 255, 0.6);
      /* Overlay to soften bg */
      backdrop-filter: blur(5px);
    }

    .topbar {
      height: 70px;
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.5);
      background: rgba(255, 255, 255, 0.4);
    }

    .content-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Sidebar Elements */
    .logo-box {
      height: 80px;
      display: flex;
      align-items: center;
      padding: 0 28px;
      font-weight: 800;
      font-size: 20px;
      background: linear-gradient(to right, #8b5cf6, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .logo-icon {
      display: none;
    }

    .nav-links {
      padding: 16px;
      flex: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 15px;
    }

    .nav-item:hover {
      background: rgba(139, 92, 246, 0.1);
      color: var(--primary);
      transform: translateX(4px);
    }

    .nav-item.active {
      background: var(--primary-grad);
      color: white;
      box-shadow: 0 8px 20px -4px rgba(139, 92, 246, 0.5);
      transform: scale(1.02);
    }

    .nav-item i {
      margin-right: 14px;
      font-size: 22px;
    }

    /* Glass Cards */
    .card {
      background: var(--bg-glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: var(--radius);
      box-shadow: var(--glass-shadow);
      padding: 24px;
      margin-bottom: 24px;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.1);
    }

    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .card-title {
      font-weight: 700;
      font-size: 18px;
      color: var(--text-main);
      letter-spacing: -0.02em;
    }

    /* Stat Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.8);
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    /* Shine effect */
    .stat-card::after {
      content: "";
      position: absolute;
      top: -50%;
      left: -60%;
      width: 20%;
      height: 200%;
      background: rgba(255, 255, 255, 0.4);
      transform: rotate(45deg);
      transition: 0.5s;
    }

    .stat-card:hover::after {
      left: 120%;
    }

    .stat-icon {
      width: 54px;
      height: 54px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      margin-right: 18px;
      color: white;
      box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.1);
      background: var(--primary);
    }

    .stat-info div:first-child {
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-info div:last-child {
      color: var(--text-main);
      font-size: 28px;
      font-weight: 800;
      margin-top: 4px;
    }

    /* Table */
    .table-container {
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      background: rgba(255, 255, 255, 0.5);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 18px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      font-weight: 700;
      background: rgba(241, 245, 249, 0.5);
      border-bottom: 2px solid rgba(255, 255, 255, 0.8);
    }

    td {
      padding: 18px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.03);
      font-size: 14px;
      font-weight: 500;
    }

    tr:hover td {
      background: rgba(139, 92, 246, 0.03);
    }

    /* Badges */
    .badge {
      padding: 6px 14px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.3px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .badge-success {
      background: #d1fae5;
      color: #047857;
    }

    .badge-danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    .badge-warn {
      background: #fef3c7;
      color: #b45309;
    }

    /* Avatars */
    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #475569;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-right: 14px;
    }

    .user-cell {
      display: flex;
      align-items: center;
    }

    .user-info div:first-child {
      font-weight: 500;
    }

    .user-info div:last-child {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Forms */
    input,
    select,
    textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid rgba(226, 232, 240, 0.6);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.8);
      transition: all 0.2s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #8b5cf6;
      background: #fff;
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
      outline: none;
    }

    label {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Buttons */
    .btn {
      padding: 12px 20px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary-grad);
      color: white;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
    }

    .btn-ghost {
      background: rgba(241, 245, 249, 0.6);
      color: var(--text-main);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: var(--shadow-sm);
      color: var(--primary);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      color: white;
    }

    border-radius: var(--radius-sm);
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-danger {
      background: var(--danger-bg);
      color: var(--danger);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      background: #f1f5f9;
      color: var(--text-main);
    }

    /* Utilities */
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .hidden {
      display: none !important;
    }

    .text-sm {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: white;
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      border-left: 4px solid var(--primary);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      width: 320px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* View Sections */
    .view-section {
      display: none;
    }

    .view-section.active {
      display: block;
    }

    /* PROFILE MODAL & PRINT STYLES */
    .profile-header {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      padding-bottom: 24px;
      border-bottom: 1px dashed var(--border);
      margin-bottom: 24px;
    }

    .profile-img-lg {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      object-fit: cover;
      background: #e2e8f0;
      border: 4px solid white;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.2s;
      position: relative;
    }

    .profile-img-lg:hover {
      transform: scale(1.05);
      border-color: var(--primary);
    }

    .profile-img-container {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .profile-img-container::after {
      content: 'Edit';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      font-size: 10px;
      text-align: center;
      padding: 4px;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .profile-img-container:hover::after {
      opacity: 1;
    }

    .profile-details {
      flex: 1;
    }

    .profile-name {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 4px;
      background: var(--primary-grad);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .profile-id {
      font-family: monospace;
      font-size: 14px;
      background: #f1f5f9;
      padding: 4px 8px;
      border-radius: 4px;
      color: var(--text-muted);
      display: inline-block;
      margin-bottom: 12px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .info-item label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 700;
      display: block;
      margin-bottom: 4px;
    }

    .info-item div {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
    }

    /* Image Upload Preview */
    .img-upload-box {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      background: #f8fafc;
      border: 2px dashed var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      position: relative;
    }

    .img-upload-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .img-upload-box i {
      font-size: 24px;
      color: var(--text-light);
    }

    .img-upload-box:hover {
      border-color: var(--primary);
      background: rgba(139, 92, 246, 0.05);
    }

    @media print {
      body * {
        visibility: hidden;
      }

      #profile-modal,
      #profile-modal * {
        visibility: visible;
      }

      #profile-modal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: white;
        padding: 0;
        margin: 0;
        display: block !important;
      }

      .modal-card {
        box-shadow: none;
        border: none;
        width: 100%;
        max-width: 100%;
        background: white !important;
        backdrop-filter: none;
      }

      .no-print {
        display: none !important;
      }

      .profile-name {
        -webkit-text-fill-color: initial;
        color: black;
        background: none;
      }
    }

    /* CHAT BOT STYLES */
    .chat-modal {
      width: 400px;
      height: 550px;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
    }

    .chat-msg.user {
      align-self: flex-end;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 2px;
    }

    .chat-msg.bot {
      align-self: flex-start;
      background: white;
      border: 1px solid var(--border);
      border-bottom-left-radius: 2px;
    }

    .chat-input-area {
      padding: 12px;
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }

    .loader {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid var(--primary);
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* FLOATING CHAT BUTTON */
    .fab-chat {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
      cursor: pointer;
      z-index: 400;
      /* below modals */
      transition: transform 0.2s, box-shadow 0.2s;
      border: none;
    }

    .fab-chat:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
    }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo-box">
      <div class="logo-icon"><i class="ri-book-read-line"></i></div>
      <span>Savitri Success</span>
    </div>

    <nav class="nav-links">
      <div class="nav-item active" onclick="APP.nav('dashboard')">
        <i class="ri-dashboard-line"></i> Dashboard
      </div>
      <div class="nav-item" onclick="APP.nav('students')">
        <i class="ri-user-smile-line"></i> Students
      </div>
      <div class="nav-item" onclick="APP.nav('archive')">
        <i class="ri-archive-line"></i> Archive
      </div>
      <div class="nav-item" onclick="APP.nav('roles')">
        <i class="ri-shield-user-line"></i> User Roles
      </div>
      <div class="nav-item" onclick="APP.nav('settings')">
        <i class="ri-settings-4-line"></i> Settings
      </div>
    </nav>

    <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
      <div class="user-cell">
        <div class="avatar"
          style="background: rgba(255,255,255,0.2); color:white; display:flex; align-items:center; justify-content:center;">
          ADMIN</div>
        <div class="user-info" style="margin-left:12px">
          <div style="font-size:14px">Administrator</div>
          <div style="opacity:0.6; font-size:12px">Library Manager</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <div class="topbar">
      <div style="font-weight:600; font-size:18px;" id="pageTitle">Dashboard</div>
      <div style="display:flex; gap:12px;">
        <button class="btn btn-primary" onclick="APP.ui.openAddStudent()">
          <i class="ri-add-line"></i> Add Student
        </button>
      </div>
    </div>

    <div class="content-scroll">
      <div class="container">

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view-section active">
          <div class="stats-grid">
            <div class="stat-card" onclick="APP.showFilteredStudents('All')">
              <div class="stat-icon" style="background:#e0e7ff; color:#4f46e5"><i class="ri-user-line"></i></div>
              <div class="stat-info">
                <div>Total Students</div>
                <div id="dash-total">0</div>
              </div>
            </div>
            <div class="stat-card" onclick="APP.showFilteredStudents('Active')">
              <div class="stat-icon" style="background:#dcfce7; color:#10b981"><i class="ri-check-double-line"></i>
              </div>
              <div class="stat-info">
                <div>Active Members</div>
                <div id="dash-active">0</div>
              </div>
            </div>
            <div class="stat-card" onclick="APP.showFilteredStudents('Due')">
              <div class="stat-icon" style="background:#fee2e2; color:#ef4444"><i
                  class="ri-money-dollar-circle-line"></i></div>
              <div class="stat-info">
                <div>Pending Dues</div>
                <div id="dash-due">â‚¹0</div>
              </div>
            </div>
            <div class="stat-card" onclick="APP.nav('archive')">
              <div class="stat-icon" style="background:#fef3c7; color:#f59e0b"><i class="ri-archive-drawer-line"></i>
              </div>
              <div class="stat-info">
                <div>Archived</div>
                <div id="dash-archived">0</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="card" style="flex:2">
              <div class="card-head">
                <div class="card-title">Recent Activity</div>
                <button class="btn btn-ghost btn-sm">View All</button>
              </div>
              <table style="width:100%">
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Action</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody id="activity-log">
                  <tr>
                    <td colspan="3" style="text-align:center; color:var(--text-muted)">No recent activity</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="card" style="flex:1">
              <div class="card-head">
                <div class="card-title">Quick Actions</div>
              </div>
              <div style="display:grid; gap:12px;">
                <button class="btn btn-ghost" onclick="APP.ui.openAddStudent()"
                  style="justify-content:flex-start; background:#f8fafc">
                  <i class="ri-user-add-line"></i> New Admission
                </button>
                <button class="btn btn-ghost" onclick="APP.nav('students')"
                  style="justify-content:flex-start; background:#f8fafc">
                  <i class="ri-money-rupee-circle-line"></i> Record Fees
                </button>
                <button class="btn btn-ghost" onclick="APP.backup.create()"
                  style="justify-content:flex-start; background:#f8fafc">
                  <i class="ri-save-3-line"></i> Create Backup
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- VIEW: STUDENTS -->
        <div id="view-students" class="view-section">
          <div class="card">
            <div class="flex-between" style="margin-bottom:20px;">
              <div style="display:flex; gap:12px; flex:1;">
                <input id="search-input" placeholder="Search students..." style="max-width:300px">
                <select id="filter-status" style="max-width:150px">
                  <option value="All">All Status</option>
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                </select>
              </div>
              <div>
                <button class="btn btn-ghost" onclick="APP.renderStudents()"><i class="ri-refresh-line"></i></button>
              </div>
            </div>

            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Mobile</th>
                    <th>Join Date</th>
                    <th>Status</th>
                    <th>Fees</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="students-table-body">
                  <!-- JS Rendered -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: ARCHIVE -->
        <div id="view-archive" class="view-section">
          <div class="card">
            <div class="card-head">
              <div class="card-title">Archive & Deleted Records</div>
              <button class="btn btn-ghost" onclick="APP.backup.create()"><i class="ri-save-line"></i> Manual
                Backup</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Archived Date</th>
                    <th>Reason</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="archive-table-body">
                  <!-- JS Rendered -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- USER ROLES VIEW -->
        <div id="view-roles" class="view-section">
          <div class="page-title">User Roles Management</div>
          <div class="card" style="max-width:600px">
            <div style="padding:20px; border-bottom:1px solid var(--border)">
              <h3 style="margin:0; font-size:16px; color:var(--text)">Assign Roles & Permissions</h3>
              <p style="color:var(--text-muted); font-size:13px; margin:4px 0 0 0">Select a user to manage their system
                access.</p>
            </div>

            <div style="padding:20px">
              <div class="form-group">
                <label>Select Person</label>
                <select id="role-user-select" onchange="APP.loadUserRoles(this.value)">
                  <option value="">-- Select User --</option>
                </select>
              </div>

              <div id="roles-container"
                style="margin-top:20px; opacity:0.5; pointer-events:none; transition:opacity 0.3s">
                <label style="margin-bottom:10px; display:block">Available Roles</label>

                <div
                  style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#f8fafc; border:1px solid var(--border); border-radius:8px; margin-bottom:10px">
                  <div>
                    <div style="font-weight:600; font-size:14px">Administrator</div>
                    <div style="font-size:12px; color:var(--text-muted)">Full system access, settings, and role
                      management.</div>
                  </div>
                  <input type="checkbox" id="role-check-admin" style="width:20px; height:20px">
                </div>

                <div
                  style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#f8fafc; border:1px solid var(--border); border-radius:8px; margin-bottom:10px">
                  <div>
                    <div style="font-weight:600; font-size:14px">SSL Bot User</div>
                    <div style="font-size:12px; color:var(--text-muted)">Access to the AI Chatbot assistant.</div>
                  </div>
                  <input type="checkbox" id="role-check-bot" style="width:20px; height:20px">
                </div>

                <div style="margin-top:20px; text-align:right">
                  <button class="btn btn-primary" onclick="APP.saveUserRoles()">Save Changes</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- VIEW: SETTINGS -->
        <div id="view-settings" class="view-section">
          <div class="card" style="max-width:600px">
            <div class="card-head">
              <div class="card-title">System Settings</div>
            </div>
            <p class="text-sm">Manage your library configuration.</p>
            <div class="form-group">
              <label>Library Name</label>
              <input value="Savitri Success Library" disabled>
            </div>

            <div style="margin-top:24px; padding-top:24px; border-top:1px solid var(--border)">
              <div class="card-title" style="font-size:16px; margin-bottom:12px;">AI Configuration (SSL Bot)</div>
              <div class="form-group">
                <label>Google Gemini API Key</label>
                <input type="password" id="inp-api-key" placeholder="Paste your API Key here">
                <p class="text-sm" style="margin-top:4px">Get your free key from <a
                    href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--primary)">Google AI
                    Studio</a></p>
              </div>
              <button class="btn btn-primary" onclick="APP.saveSettings()">Save Configuration</button>
            </div>
            <div class="form-group">
              <label>Data Location</label>
              <div class="text-sm" style="background:#f1f5f9; padding:12px; border-radius:8px; font-family:monospace">
                /data.json (Server Storage)
              </div>
            </div>
            <div class="form-group">
              <label>Danger Zone</label>
              <button class="btn btn-danger" onclick="alert('Contact support to reset system.')">Reset System</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- MODAL: ADD/EDIT STUDENT -->
  <div id="student-modal"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:500; align-items:center; justify-content:center;">
    <div class="card" style="width:600px; max-width:90%; padding:0; overflow:hidden;">
      <div class="card-head" style="padding:20px; border-bottom:1px solid var(--border); margin:0;">
        <div class="card-title" id="modal-title">Add Student</div>
        <button class="btn btn-ghost" onclick="APP.ui.closeModal()" style="padding:4px;"><i
            class="ri-close-line"></i></button>
      </div>
      <div style="padding:20px; overflow-y:auto; max-height:70vh;">
        <form id="student-form" onsubmit="event.preventDefault(); APP.saveStudent();">
          <input type="hidden" id="inp-id">

          <div style="display:flex; gap:20px; margin-bottom:20px;">
            <!-- Image Upload -->
            <div class="img-upload-box" onclick="document.getElementById('inp-file').click()">
              <img id="preview-img" style="display:none">
              <i id="upload-icon" class="ri-camera-line"></i>
              <input type="file" id="inp-file" accept="image/*" style="display:none"
                onchange="APP.handleImageUpload(this)">
              <input type="hidden" id="inp-image-url">
            </div>
            <div style="flex:1">
              <div class="form-group">
                <label>Full Name</label>
                <input id="inp-name" required placeholder="e.g. Rahul Sharma">
              </div>
              <div class="form-group">
                <label>Mobile Number</label>
                <input id="inp-mobile" required placeholder="10 digits">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="form-group">
              <label>Monthly Fee (â‚¹)</label>
              <input id="inp-fee" type="number" required>
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="inp-status">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>User Role</label>
            <select id="inp-role">
              <option value="Student">Student</option>
              <option value="SSL Bot User">SSL Bot User</option>
              <option value="Admin">Admin</option>
            </select>
            <small style="color:var(--text-muted); font-size:11px">Select 'SSL Bot User' to enable chatbot
              access.</small>
          </div>
          <div class="row">
            <div class="form-group">
              <label>Admission Date</label>
              <input id="inp-date" type="date">
            </div>
            <div class="form-group">
              <label>Student ID (Auto)</label>
              <input id="inp-code" disabled style="background:#f1f5f9; color:var(--text-muted)">
            </div>
          </div>
          <div class="form-group">
            <label>Notes / Address</label>
            <textarea id="inp-notes" rows="2"></textarea>
          </div>
          <!-- Fees Payment Section (Only for Edit) -->
          <div id="payment-section" class="hidden"
            style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border)">
            <label style="margin-bottom:10px">Recent Payments</label>
            <div id="payment-history" class="text-sm" style="margin-bottom:12px; max-height:100px; overflow-y:auto;">
            </div>
            <div class="row" style="align-items:end">
              <div class="form-group" style="margin:0">
                <label>Month (Fee For)</label>
                <input type="month" id="inp-pay-month">
              </div>
              <div class="form-group" style="margin:0">
                <label>Payment Date</label>
                <input type="date" id="inp-pay-date">
              </div>
              <button class="btn btn-primary" type="button" onclick="APP.addPayment()">Record Paid</button>
            </div>
          </div>
        </form>
      </div>
      <div
        style="padding:16px 20px; background:#f8fafc; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:12px;">
        <button class="btn btn-danger hidden" id="btn-delete" type="button"
          onclick="APP.archiveStudent()">Archive</button>
        <button class="btn btn-ghost" type="button" onclick="APP.ui.closeModal()">Cancel</button>
        <button class="btn btn-primary" type="button"
          onclick="document.getElementById('student-form').requestSubmit()">Save Record</button>
      </div>
    </div>
  </div>

  <!-- MODAL: PROFILE CARD -->
  <div id="profile-modal"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:600; align-items:center; justify-content:center;">
    <div class="card modal-card" style="width:500px; max-width:90%; padding:30px; position:relative; overflow:hidden;">
      <button class="btn btn-ghost no-print" onclick="document.getElementById('profile-modal').style.display='none'"
        style="position:absolute; top:20px; right:20px"><i class="ri-close-line"></i></button>

      <div class="profile-header">
        <div class="profile-img-container" id="prof-img-container" title="Click to Edit Photo">
          <img id="prof-img" class="profile-img-lg" src="">
        </div>
        <div class="profile-details">
          <div id="prof-name" class="profile-name">Student Name</div>
          <div id="prof-id" class="profile-id">SSL-000</div>
          <div class="badge badge-success" id="prof-status">Active</div>
        </div>
      </div>

      <div class="info-grid">
        <div class="info-item"><label>Mobile</label>
          <div id="prof-mobile">-</div>
        </div>
        <div class="info-item"><label>Monthly Fee</label>
          <div id="prof-fee">-</div>
        </div>
        <div class="info-item"><label>Admission Date</label>
          <div id="prof-join">-</div>
        </div>
        <div class="info-item"><label>Address/Notes</label>
          <div id="prof-notes" style="font-size:13px; font-weight:500">-</div>
        </div>
      </div>

      <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
        <label style="margin-bottom:12px; display:block">Payment History (Last 5)</label>
        <table class="table-sm" style="font-size:12px;">
          <thead>
            <tr style="background:#f8fafc; color:var(--text-muted)">
              <th style="padding:8px">Month</th>
              <th style="padding:8px">Paid Date</th>
              <th style="padding:8px">Amount</th>
            </tr>
          </thead>
          <tbody id="prof-payments"></tbody>
        </table>
      </div>

      <div class="no-print" style="margin-top:30px; display:flex; justify-content:center;">
        <button class="btn btn-primary" onclick="window.print()"><i class="ri-printer-line"></i> Print ID /
          Profile</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CHAT BOT -->
  <div id="chat-modal"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:700; align-items:center; justify-content:center;">
    <div class="card chat-modal" style="padding:0; overflow:hidden">
      <div class="card-head" style="padding:16px; background:var(--primary); color:white; border-bottom:none">
        <div style="display:flex; align-items:center; gap:10px">
          <div
            style="width:32px; height:32px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--primary)">
            <i class="ri-robot-2-line"></i>
          </div>
          <div style="font-weight:700">SSL Bot</div>
        </div>
        <button class="btn btn-ghost" onclick="document.getElementById('chat-modal').style.display='none'"
          style="color:white; padding:4px"><i class="ri-close-line"></i></button>
      </div>
      <div id="chat-messages" class="chat-messages">
        <!-- Messages go here -->
        <div class="chat-msg bot">Hello! I am your SSL Bot. How can I help you today?</div>
      </div>
      <div class="chat-input-area">
        <input id="chat-input" placeholder="Ask a question..."
          style="flex:1; border:1px solid var(--border); padding:8px 12px; border-radius:20px; outline:none">
        <button class="btn btn-primary" style="padding:8px 12px; border-radius:50%" onclick="APP.sendChatMessage()"><i
            class="ri-send-plane-fill"></i></button>
      </div>
    </div>
  </div>

  <!-- ADMIN CHAT BUTTON -->
  <button class="fab-chat" onclick="APP.openChat('Admin')" title="Chat with SSL Bot">
    <i class="ri-robot-2-line"></i>
  </button>

  <div class="toast-container" id="toast-container"></div>

  <script>
    const API = {
      get: async (url) => {
        const res = await fetch(url);
        if (!res.ok) {
          const text = await res.text();
          try { return JSON.parse(text); } catch { throw new Error(`Server Error (${res.status}). Please restart the server.`); }
        }
        return res.json();
      },
      post: async (url, data) => {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const text = await res.text();
        let json;
        try {
          json = JSON.parse(text);
        } catch (e) {
          throw new Error(`Server Error (${res.status}): Response was not JSON. Please restart the backend server.`);
        }
        if (!res.ok) throw new Error(json.error || 'Request failed');
        return json;
      }
    };

    const APP = {
      data: { students: [] },
      archive: { archived: [] },
      settings: {},

      init: async () => {
        await APP.loadData();
        await APP.loadSettings();
        APP.renderDashboard();
        APP.renderStudents();

        // Search Listener
        document.getElementById('search-input').addEventListener('input', (e) => {
          APP.renderStudents(e.target.value);
        });

        // Chat Enter Key
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') APP.sendChatMessage();
        });
      },

      loadData: async () => {
        try {
          const res = await API.get('/api/data');
          APP.data = res;
          try {
            const arc = await API.get('/api/archive');
            APP.archive = arc;
          } catch (e) { }
        } catch (e) {
          APP.ui.toast('Failed to load data', 'error');
        }
      },

      // ... (Rest of APP object) ... 

      // I need to be careful with replace_file_content context. 
      // safer to just target the specific functions if possible, but API definition is outside APP.

      // Let's just target API definition first, then I'll call another tool for saveSettings


      nav: (page) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + page).classList.add('active');

        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active'); // simple logic

        document.getElementById('pageTitle').innerText = page.charAt(0).toUpperCase() + page.slice(1).replace('Roles', ' Roles'); // Fix title formatting

        if (page === 'archive') APP.renderArchive();
        if (page === 'dashboard') APP.renderDashboard();
        if (page === 'roles') APP.renderRolesView();
      },

      showFilteredStudents: (filterType) => {
        APP.nav('students'); // Switch to students view
        const select = document.getElementById('filter-status');
        const input = document.getElementById('search-input');

        // Reset Search
        input.value = '';

        if (filterType === 'Due') {
          select.value = 'All'; // We need custom logic for 'Due', handled in renderStudents
          APP.renderStudents('', 'Due');
          APP.ui.toast('Showing students with pending dues', 'info');
        } else {
          select.value = filterType;
          APP.renderStudents();
          APP.ui.toast(`Showing ${filterType} students`, 'info');
        }
      },

      // --- RENDERERS ---

      renderDashboard: () => {
        const total = APP.data.students.length;
        const active = APP.data.students.filter(s => s.status === 'Active').length;
        const archived = APP.archive.archived ? APP.archive.archived.length : 0;

        // Calculate dues
        const thisMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
        let pending = 0;
        APP.data.students.forEach(s => {
          if (s.status !== 'Active') return;
          const paid = (s.payments || []).some(p => p.paidForMonth === thisMonth);
          if (!paid) pending += Number(s.monthlyFee || 0);
        });

        document.getElementById('dash-total').innerText = total;
        document.getElementById('dash-active').innerText = active;
        document.getElementById('dash-archived').innerText = archived;
        document.getElementById('dash-due').innerText = 'â‚¹' + pending.toLocaleString();

        APP.renderActivityLog();
      },

      renderStudents: (query = '', customFilter = null) => {
        const tbody = document.getElementById('students-table-body');
        tbody.innerHTML = '';

        const filter = document.getElementById('filter-status').value;
        const q = query.toLowerCase();

        const thisMonth = new Date().toISOString().slice(0, 7);

        const list = APP.data.students.filter(s => {
          // Standard Status Filter
          if (!customFilter && filter !== 'All' && s.status !== filter) return false;

          // Search Filter
          if (q && !s.name.toLowerCase().includes(q) && !s.mobile.includes(q)) return false;

          // Custom 'Due' Filter
          if (customFilter === 'Due') {
            if (s.status !== 'Active') return false; // Only active can have dues
            const isPaid = (s.payments || []).some(p => p.paidForMonth === thisMonth);
            if (isPaid) return false; // Skip if paid
          }

          return true;
        });

        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#94a3b8">No students found</td></tr>';
          return;
        }

        // 'thisMonth' is already defined above

        list.forEach(s => {
          const isPaid = (s.payments || []).some(p => p.paidForMonth === thisMonth);
          const statusBadge = s.status === 'Active' ? 'badge-success' : 'badge-warn';
          const feeBadge = isPaid ? '<span class="badge badge-success">Paid</span>' : '<span class="badge badge-danger">Due</span>';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>
              <div class="user-cell">
                <div class="avatar" style="display:flex;align-items:center;justify-content:center;font-size:12px;color:#64748b">${s.name.charAt(0)}</div>
                <div class="user-info">
                  <div>${s.name}</div>
                  <div>${s.studentCode || 'ID-?'}</div>
                </div>
              </div>
            </td>
            <td>${s.mobile}</td>
            <td>${s.admissionDate || '-'}</td>
            <td><span class="badge ${statusBadge}">${s.status}</span></td>
            <td>${feeBadge} <span style="font-size:12px;color:#64748b;margin-left:4px">â‚¹${s.monthlyFee}</span></td>
            <td>
              <button class="btn btn-ghost" onclick="APP.ui.openProfile('${s.id}')" style="padding:6px; margin-right:4px; color:var(--primary)" title="View Profile"><i class="ri-information-fill"></i></button>
              <button class="btn btn-ghost" onclick="APP.ui.openEditStudent('${s.id}')" style="padding:6px" title="Edit"><i class="ri-edit-line"></i></button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      },

      renderRolesView: () => {
        const select = document.getElementById('role-user-select');
        select.innerHTML = '<option value="">-- Select User --</option>';

        APP.data.students.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.innerText = `${s.name} (${s.studentCode})`;
          select.appendChild(opt);
        });

        // Reset UI
        document.getElementById('roles-container').style.opacity = '0.5';
        document.getElementById('roles-container').style.pointerEvents = 'none';
        document.getElementById('role-check-admin').checked = false;
        document.getElementById('role-check-bot').checked = false;
      },

      loadUserRoles: (id) => {
        const container = document.getElementById('roles-container');
        if (!id) {
          container.style.opacity = '0.5';
          container.style.pointerEvents = 'none';
          return;
        }

        const s = APP.data.students.find(x => x.id === id);
        if (!s) return;

        container.style.opacity = '1';
        container.style.pointerEvents = 'auto';

        // Set Checkboxes
        document.getElementById('role-check-admin').checked = (s.role === 'Admin');
        document.getElementById('role-check-bot').checked = (s.botAccess === true);
      },

      saveUserRoles: async () => {
        const id = document.getElementById('role-user-select').value;
        if (!id) return;

        const s = APP.data.students.find(x => x.id === id);
        const isAdmin = document.getElementById('role-check-admin').checked;
        const isBot = document.getElementById('role-check-bot').checked;

        s.role = isAdmin ? 'Admin' : (isBot ? 'SSL Bot User' : 'Student');
        s.botAccess = isBot || isAdmin; // Admin always gets bot access implicitly or explicitly? Let's keep existing logic: botAccess boolean.

        await API.post('/api/data', APP.data);
        APP.ui.toast('User roles updated successfully', 'success');
      },

      renderArchive: async () => {
        try {
          const res = await API.get('/api/archive');
          APP.archive = res;
          const list = res.archived || [];
          const tbody = document.getElementById('archive-table-body');
          tbody.innerHTML = '';

          if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px">Archive is empty</td></tr>';
            return;
          }

          list.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
               <td>
                 <div class="user-cell">
                    <div class="user-info">
                      <div>${s.name}</div>
                      <div>${s.studentCode}</div>
                    </div>
                 </div>
               </td>
               <td>${new Date(s.archivedAt).toLocaleDateString()}</td>
               <td><span class="badge badge-warn">${s.archivedReason}</span></td>
               <td>
                 <button class="btn btn-primary" style="padding:4px 10px; font-size:12px" onclick="APP.restoreStudent('${s.id}')">Restore</button>
               </td>
             `;
            tbody.appendChild(tr);
          });
        } catch (e) { console.error(e); }
      },

      // --- ACTIONS ---

      handleImageUpload: async (input) => {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          const reader = new FileReader();
          reader.onload = async function (e) {
            // Show preview
            document.getElementById('preview-img').src = e.target.result;
            document.getElementById('preview-img').style.display = 'block';
            document.getElementById('upload-icon').style.display = 'none';

            // Upload to server
            try {
              const res = await API.post('/api/upload', { image: e.target.result });
              if (res.ok) {
                document.getElementById('inp-image-url').value = res.url;
                APP.ui.toast('Image uploaded', 'success');
              }
            } catch (err) {
              console.error(err);
              APP.ui.toast('Image upload failed', 'error');
            }
          };
          reader.readAsDataURL(file);
        }
      },

      saveStudent: async () => {
        const id = document.getElementById('inp-id').value;
        const name = document.getElementById('inp-name').value;
        const mobile = document.getElementById('inp-mobile').value;
        const fee = document.getElementById('inp-fee').value;
        const status = document.getElementById('inp-status').value;
        const role = document.getElementById('inp-role').value;
        const notes = document.getElementById('inp-notes').value;
        const date = document.getElementById('inp-date').value;
        const imageUrl = document.getElementById('inp-image-url').value;

        if (!name || !mobile) return;

        const botAccess = (role === 'SSL Bot User' || role === 'Admin');

        let student;
        if (id) {
          student = APP.data.students.find(s => s.id === id);
          Object.assign(student, { name, mobile, monthlyFee: fee, status, role, botAccess, notes, admissionDate: date, imageUrl });
          APP.ui.toast('Updated successfully', 'success');
        } else {
          // New Student
          const nextNum = APP.data.students.length + 1;
          const code = 'SSL-' + String(nextNum).padStart(3, '0');

          student = {
            id: Math.random().toString(36).substr(2, 9),
            studentCode: code,
            name, mobile, monthlyFee: fee, status, role, botAccess, notes, admissionDate: date, imageUrl,
            payments: []
          };
          APP.data.students.push(student);
          APP.ui.toast(`Student added (${code})`, 'success');
        }

        await API.post('/api/data', APP.data);
        APP.ui.closeModal();
        APP.renderStudents();
        APP.renderDashboard();
      },

      archiveStudent: async () => {
        const id = document.getElementById('inp-id').value;
        const student = APP.data.students.find(s => s.id === id);
        if (!student) return;

        if (!confirm(`Archive ${student.name}?`)) return;

        await fetch('/api/archive/student', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ student, reason: 'Manual Archive' })
        });

        // Optimistic update
        APP.data.students = APP.data.students.filter(s => s.id !== id);
        APP.ui.closeModal();
        APP.renderStudents();
        APP.renderDashboard();
        APP.ui.toast('Student archived', 'success');
      },

      restoreStudent: async (id) => {
        await fetch(`/api/restore/${id}`, { method: 'POST' });
        APP.loadData(); // reload all
        setTimeout(() => {
          APP.renderArchive();
          APP.ui.toast('Restored successfully', 'success');
        }, 500);
      },

      addPayment: async () => {
        const id = document.getElementById('inp-id').value;
        const month = document.getElementById('inp-pay-month').value;
        const date = document.getElementById('inp-pay-date').value;

        if (!month) return alert('Select a month');
        if (!date) return alert('Select payment date');

        const student = APP.data.students.find(s => s.id === id);

        // Remove existing if any for same month
        if (student.payments) {
          student.payments = student.payments.filter(p => p.paidForMonth !== month);
        } else {
          student.payments = [];
        }

        student.payments.push({
          id: Math.random().toString(36),
          paidForMonth: month,
          amount: student.monthlyFee,
          paidDate: date,
          timestamp: new Date().toISOString() // for exact sorting
        });

        await API.post('/api/data', APP.data);
        APP.ui.toast('Payment recorded', 'success');
        APP.ui.openEditStudent(id); // Re-render modal list
        APP.renderStudents();
        APP.renderDashboard();
      },

      renderActivityLog: () => {
        const tbody = document.getElementById('activity-log');
        tbody.innerHTML = '';

        let activities = [];
        APP.data.students.forEach(s => {
          if (s.payments) {
            s.payments.forEach(p => {
              activities.push({
                student: s.name,
                action: 'Paid Fee',
                amount: p.amount,
                date: p.paidDate,
                ts: p.timestamp || p.paidDate
              });
            });
          }
          // Can add other activities like 'Joined' based on admissionDate if needed
        });

        // Sort by newest
        activities.sort((a, b) => new Date(b.ts) - new Date(a.ts));

        // Take top 10
        const recent = activities.slice(0, 10);

        if (recent.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:var(--text-muted); padding:20px;">No recent activity</td></tr>';
          return;
        }

        recent.forEach(act => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
             <td><span style="font-weight:600">${act.student}</span></td>
             <td>
               <span class="badge badge-success">â‚¹${act.amount}</span> 
               <span style="font-size:12px; margin-left:6px; color:var(--text-muted)">via Fees</span>
             </td>
             <td style="font-size:12px; color:var(--text-muted)">${new Date(act.date).toLocaleDateString()}</td>
           `;
          tbody.appendChild(tr);
        });
      },

      backup: {
        create: async () => {
          const res = await API.post('/api/backup', {});
          if (res.ok) APP.ui.toast('Backup created: ' + res.backup, 'success');
        }
      },

      // --- SETTINGS & CHAT ---
      loadSettings: async () => {
        try {
          const res = await API.get('/api/settings');
          if (res.apiKey) document.getElementById('inp-api-key').value = res.apiKey;
        } catch (e) { console.error(e); }
      },

      saveSettings: async () => {
        const apiKey = document.getElementById('inp-api-key').value;
        if (!apiKey) return alert('Please enter an API Key');
        try {
          await API.post('/api/settings', { apiKey });
          APP.ui.toast('Settings saved', 'success');
        } catch (e) {
          console.error(e);
          APP.ui.toast(e.message, 'error');
        }
      },

      openChat: (studentName) => {
        const modal = document.getElementById('chat-modal');
        const msgs = document.getElementById('chat-messages');
        msgs.innerHTML = `<div class="chat-msg bot">Hello ${studentName}! I am your SSL Bot. How can I help you today?</div>`;
        APP.chatHistory = [];
        modal.style.display = 'flex';
        document.getElementById('chat-input').focus();
      },

      sendChatMessage: async () => {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;

        const msgs = document.getElementById('chat-messages');

        // User Message
        const userDiv = document.createElement('div');
        userDiv.className = 'chat-msg user';
        userDiv.innerText = text;
        msgs.appendChild(userDiv);
        input.value = '';
        msgs.scrollTop = msgs.scrollHeight;

        // Bot Loading
        const loaderDiv = document.createElement('div');
        loaderDiv.className = 'chat-msg bot';
        loaderDiv.innerHTML = '<span class="loader"></span>';
        msgs.appendChild(loaderDiv);

        try {
          APP.chatHistory = APP.chatHistory || [];

          const res = await API.post('/api/chat', {
            message: text,
            history: APP.chatHistory
          });

          loaderDiv.remove();

          if (res.error) {
            APP.ui.toast(res.error, 'error');
            return;
          }

          // Bot Message
          const botDiv = document.createElement('div');
          botDiv.className = 'chat-msg bot';
          // Simple markdown Bold/Italic support could be added here
          botDiv.innerText = res.text;
          msgs.appendChild(botDiv);
          msgs.scrollTop = msgs.scrollHeight;

          // Update history
          APP.chatHistory.push({ role: 'user', text: text });
          APP.chatHistory.push({ role: 'model', text: res.text });

        } catch (e) {
          loaderDiv.remove();
          console.error(e);
          APP.ui.toast(e.message || 'Failed to get response', 'error');
        }
      },

      // --- UI HELPERS ---
      ui: {
        openAddStudent: () => {
          APP.ui.openEditStudent();
        },

        openEditStudent: (id = null) => {
          const modal = document.getElementById('student-modal');
          const title = document.getElementById('modal-title');
          const form = document.getElementById('student-form');
          const btnDelete = document.getElementById('btn-delete');
          const paymentSection = document.getElementById('payment-section');
          const previewImg = document.getElementById('preview-img');
          const uploadIcon = document.getElementById('upload-icon');

          form.reset();
          previewImg.style.display = 'none';
          previewImg.src = '';
          uploadIcon.style.display = 'block';
          document.getElementById('inp-image-url').value = '';

          if (id) {
            const s = APP.data.students.find(s => s.id === id);
            title.innerText = 'Edit Student';
            document.getElementById('inp-id').value = s.id;
            document.getElementById('inp-name').value = s.name;
            document.getElementById('inp-mobile').value = s.mobile;
            document.getElementById('inp-fee').value = s.monthlyFee;
            document.getElementById('inp-status').value = s.status || 'Active';
            document.getElementById('inp-notes').value = s.notes || '';
            document.getElementById('inp-date').value = s.admissionDate || '';
            document.getElementById('inp-code').value = s.studentCode || '';
            document.getElementById('inp-image-url').value = s.imageUrl || '';

            // Set Role
            const roleSelect = document.getElementById('inp-role');
            if (s.role) {
              roleSelect.value = s.role;
            } else {
              roleSelect.value = s.botAccess ? 'SSL Bot User' : 'Student';
            }

            if (s.imageUrl) {
              previewImg.src = s.imageUrl;
              previewImg.style.display = 'block';
              uploadIcon.style.display = 'none';
            }

            btnDelete.classList.remove('hidden');
            paymentSection.classList.remove('hidden');

            // Render payment history
            const historyContainer = document.getElementById('payment-history');
            historyContainer.innerHTML = '';
            const payments = (s.payments || []).sort((a, b) => new Date(b.paidForMonth) - new Date(a.paidForMonth));

            if (payments.length > 0) {
              payments.forEach(p => {
                const div = document.createElement('div');
                div.style = "display:flex; justify-content:space-between; padding:6px; border-bottom:1px solid #f1f5f9";
                div.innerHTML = `
                  <div style="display:flex; gap:10px">
                    <span>${p.paidForMonth}</span>
                    <span style="font-size:11px; color:#94a3b8; align-self:center">${p.paidDate || ''}</span>
                  </div>
                  <span style="font-weight:600; color:#10b981">â‚¹${p.amount}</span>`;
                historyContainer.appendChild(div);
              });
            } else {
              historyContainer.innerHTML = '<div style="color:#cbd5e1; font-style:italic">No payments recorded</div>';
            }

          } else {
            title.innerText = 'Add Student';
            document.getElementById('inp-id').value = '';
            document.getElementById('inp-code').value = 'NEW';
            btnDelete.classList.add('hidden');
            paymentSection.classList.add('hidden');
            document.getElementById('inp-date').value = new Date().toISOString().slice(0, 10);
          }
          modal.style.display = 'flex';
        },

        openProfile: (id) => {
          const s = APP.data.students.find(s => s.id === id);
          if (!s) return;

          const modal = document.getElementById('profile-modal');

          document.getElementById('prof-name').innerText = s.name;
          document.getElementById('prof-id').innerText = s.studentCode || '-';
          document.getElementById('prof-status').innerText = s.status;
          const statusBadge = document.getElementById('prof-status');
          statusBadge.className = `badge ${s.status === 'Active' ? 'badge-success' : 'badge-warn'}`;
          statusBadge.innerText = s.status;

          document.getElementById('prof-mobile').innerText = s.mobile;
          document.getElementById('prof-fee').innerText = 'â‚¹' + s.monthlyFee;
          document.getElementById('prof-join').innerText = s.admissionDate || '-';
          document.getElementById('prof-notes').innerText = s.notes || '-';

          const img = document.getElementById('prof-img');
          const imgContainer = document.getElementById('prof-img-container');

          if (imgContainer) {
            imgContainer.onclick = () => {
              APP.ui.closeModal();
              APP.ui.openEditStudent(s.id);
              setTimeout(() => APP.ui.toast('Click camera icon to change photo', 'info'), 500);
            };
          }

          if (s.imageUrl) {
            img.src = s.imageUrl;
            img.style.display = 'block';
          } else {
            // Placeholder
            img.src = 'https://cdn.jsdelivr.net/npm/remixicon@2.5.0/icons/User/user-3-fill.svg';
            img.style.padding = '20px';
            img.style.backgroundColor = '#e2e8f0';
          }
          img.onerror = () => {
            img.src = 'https://cdn.jsdelivr.net/npm/remixicon@2.5.0/icons/User/user-3-fill.svg';
            img.style.padding = '20px';
          };

          // Chat Button
          const existingBtn = document.getElementById('btn-chat-open');
          if (existingBtn) existingBtn.remove();

          if (s.botAccess) {
            const btn = document.createElement('button');
            btn.id = 'btn-chat-open';
            btn.className = 'btn btn-primary no-print';
            btn.style.width = '100%';
            btn.style.marginTop = '16px';
            btn.style.marginBottom = '16px';
            btn.innerHTML = '<i class="ri-robot-2-fill"></i> Chat with SSL Bot';
            btn.onclick = () => {
              document.getElementById('profile-modal').style.display = 'none';
              APP.openChat(s.name);
            };

            // Append to profile modal content
            // We can insert it before the payment history
            const paymentsSection = document.getElementById('prof-payments').parentNode.parentNode; // table -> div
            // Actually, easier to insert after info-grid if we query it, or simply use insertBefore
            const modalBody = document.querySelector('#profile-modal .modal-card');
            // There is a div margin-top:20px for payment history (line 1093)
            // Let's insert before that div
            // We need a stable anchor. 
            // Let's insert after info-grid div.
            const infoGrid = modalBody.querySelector('.info-grid');
            if (infoGrid) infoGrid.after(btn);
          }

          const tbody = document.getElementById('prof-payments');
          tbody.innerHTML = '';

          const payments = (s.payments || []).sort((a, b) => new Date(b.paidForMonth) - new Date(a.paidForMonth)).slice(0, 5);

          if (payments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:10px; color:#94a3b8">No payments</td></tr>';
          } else {
            payments.forEach(p => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                    <td style="padding:8px">${p.paidForMonth}</td>
                    <td style="padding:8px">${p.paidDate || '-'}</td>
                    <td style="padding:8px">â‚¹${p.amount}</td>
                 `;
              tbody.appendChild(tr);
            });
          }

          modal.style.display = 'flex';
        },

        closeModal: () => {
          document.getElementById('student-modal').style.display = 'none';
          document.getElementById('profile-modal').style.display = 'none';
        },

        toast: (msg, type = 'success') => {
          const c = document.getElementById('toast-container');
          const el = document.createElement('div');
          el.className = 'toast';
          el.style.borderLeftColor = type === 'error' ? 'var(--danger)' : 'var(--primary)';
          el.innerHTML = `
            <div>
              <div style="font-weight:600">${type === 'error' ? 'Error' : 'Success'}</div>
              <div style="font-size:14px; color:#64748b">${msg}</div>
            </div>`;
          c.appendChild(el);
          setTimeout(() => el.remove(), 3000);
        }
      }
    };

    // BOOT
    window.addEventListener('DOMContentLoaded', APP.init);
  </script>
</body>

</html>